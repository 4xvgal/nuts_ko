# NUT-03: 토큰 교환 (Swap tokens)

`mandatory`

---

스왑(Swap) 연산은 Cashu 시스템의 핵심 구성 요소이다.  
스왑 연산은 여러 개의 입력(`Proofs`)과 출력(`BlindedMessages`)으로 구성된다.  
민트는 입력을 검증하고 무효화한 뒤, 새로운 약속(`BlindSignatures`)을 발행한다.  
지갑은 이 약속을 사용하여 새로운 `Proofs`를 생성한다. (참조: [NUT-00][00])

스왑 연산은 여러 사용 사례에 활용될 수 있다.  
첫 번째는 `Alice`가 필요한 금액을 보낼 수 있도록 토큰을 분할(splitting)하는 경우이다.  
예를 들어, `Alice`가 `Carol`에게 보낼 정확한 금액 단위를 지갑에 가지고 있지 않을 때 이를 위해 스왑을 사용한다.  
두 번째는 `Carol`의 지갑이 `Alice`로부터 받은 토큰을 민트에 제출하여 새로운 출력으로 교환받는 경우이다.


## 송신을 위한 스왑 (Swap to send)

다음은 `Alice`가 `Carol`에게 토큰을 보내는 일반적인 예시이다.

`Alice`의 지갑에는 64 sat이 있으며, `[32, 16, 16]`의 세 개의 `Proof`로 구성되어 있다.  
`Alice`는 `Carol`에게 40 sat을 보내고 싶지만, 정확히 40 sat을 만들 수 있는 조합을 가지고 있지 않다.  
따라서 `Alice`는 민트에 스왑 요청을 보내며 `[16, 16, 32]`를 입력으로 사용하고, `[8, 32, 8, 16]`을 출력으로 요청한다.  
총합은 동일하게 64 sat이다. 이제 첫 번째 두 토큰 `[8, 32]`을 조합하여 40 sat을 만들 수 있다.  
`Alice`가 스왑 입력으로 제출한 `Proofs`는 이제 무효화된다.

> **참고:** 사용자가 송금 금액과 잔돈의 비율을 민트가 유추하지 못하도록 하려면,  
> 클라이언트는 **요청한 출력 금액 목록을 반드시 오름차순으로 정렬해야 한다.**  
> 예를 들어 `[16, 8, 2, 64, 8]`처럼 요청하면 26 sat 결제를 준비 중이라는 정보가 노출될 수 있다.  
> 대신 `[2, 8, 8, 16, 64]`로 정렬하여 이 프라이버시 누출을 완화해야 한다.


## 수신을 위한 스왑 (Swap to receive)

다음은 `Alice`의 송신 예시를 이어가는 수신 측(`Carol`)의 케이스이다.  
`Alice`가 스왑을 통해 전송할 준비가 된 `Proofs`를 만들었을 때, `Carol`은 동일한 연산을 사용하여 이를 수신한다.  
즉, `Alice`로부터 받은 `Proofs`를 입력으로 제출하여 무효화하고, 민트로부터 새로운 출력을 요청한다.  
`Carol`이 새로운 출력을 성공적으로 수령했을 때만, `Alice`는 동일한 `Proofs`를 이중지불할 수 없게 된다.  
이 시점에서 거래는 정산(settle)된다.  

예시를 계속하면, `Carol`은 `[32, 8]`의 입력을 사용하여 동일한 총액의 새로운 출력들을 요청한다.


## 예시

**Alice의 요청:**

```http
POST https://mint.host:3338/v1/swap
```

요청 데이터(`PostSwapRequest`) 형식:

```json
{
  "inputs": <Array[Proof]>,
  "outputs": <Array[BlindedMessage]>
}
```

**curl 예시:**

```bash
curl -X POST https://mint.host:3338/v1/swap -d {
  "inputs":
    [
      {
        "amount": 2,
        "id": "009a1f293253e41e",
        "secret": "407915bc212be61a77e3e6d2aeb4c727980bda51cd06a6afc29e2861768a7837",
        "C": "02bc9097997d81afb2cc7346b5e4345a9346bd2a506eb7958598a72f0cf85163ea"
      },
      {
      ...
      }
    ],
  "outputs":
    [
      {
        "amount": 2,
        "id": "009a1f293253e41e",
        "B_": "02634a2c2b34bec9e8a4aba4361f6bf202d7fa2365379b0840afe249a7a9d71239"
      },
      {
      ...
      }
    ]
}
```

성공 시, `Bob`(민트)은 `PostSwapResponse`로 다음을 반환한다.

```json
{
  "signatures": <Array[BlindSignature]>
}
```


[00]: 00.md  
[01]: 01.md  
[02]: 02.md  
[03]: 03.md  
[04]: 04.md  
[05]: 05.md  
[06]: 06.md  
[07]: 07.md  
[08]: 08.md  
[09]: 09.md  
[10]: 10.md  
[11]: 11.md  
[12]: 12.md  
