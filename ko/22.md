# NUT-22: 블라인드 인증

`optional`

`depends on: NUT-21, NUT-12`

---

이 NUT는 민트 운영자가 승인된 사용자 집합에게만 민트 사용을 제한하면서도 그 익명성 집합 내에서 프라이버시를 유지할 수 있는 블라인드 인증 방식을 정의한다.

우리는 두 가지 인증 방식을 함께 사용한다: 외부 OpenID Connect / OAuth 2.0 서비스를 이용한 **명시적 인증**(clear authentication, [NUT-21][21]에 설명됨)과 민트 리소스 접근을 위한 **블라인드 인증**. 사용자의 월렛은 먼저 민트가 지정한 OpenID Connect 기관으로부터 명시적 인증 토큰(CAT)을 받아야 하며, 이는 본 명세의 범위가 아니다. 사용자가 OpenID Connect 서비스로부터 CAT을 획득하면, 이를 사용해 민트에서 여러 개의 블라인드 인증 토큰(BAT)을 받을 수 있다. 이 문서에서는 해당 과정을 설명한다.

블라인드 인증 토큰(BAT)은 민트의 보호된 엔드포인트 접근에 사용되며, 유효한 CAT을 제시한 사용자만 민팅, 멜팅, eCash 스왑과 같은 민트 기능을 사용할 수 있도록 보장한다. 월렛은 민트의 보호된 엔드포인트에 요청할 때 요청 헤더에 BAT를 포함한다. 민트는 헤더에서 BAT를 파싱하고, [NUT-00][00]에 설명된 것처럼 서명을 검증하며, 이전에 사용된 토큰인지 확인한 뒤, 사용되지 않은 경우 민트의 사용 처리된 BAT 데이터베이스에 추가한다.

## 블라인드 인증 토큰은 eCash이다

BAT는 본질적으로 일반 eCash 토큰과 동일하며, 동일한 방식으로 발행된다. 이 토큰은 민트의 특별 키셋으로 서명되며, 단위는 `auth`, 금액은 `1`만 존재한다.

BAT는 월렛이 민트의 보호된 엔드포인트에 보내는 각 요청마다 한 번만 사용할 수 있다. 요청이 성공하면 BAT는 사용 처리되며, 이후에는 사용된 것으로 간주된다. 요청이 오류로 끝나면 BAT는 사용 처리되지 않는다.

요약:

- 월렛이 민트에 연결되고, 사용자에게 OAuth 2.0 서비스 로그인/등록이 요청됨
- 로그인 후, 월렛은 사용자를 식별하는 CAT을 수신
- CAT을 이용하여 민트에서 BAT 발급
- BAT를 사용해 민트 접근

아래는 프로토콜 흐름이다.

```

┌──────────────────────────────────────────────────────────────────────────┐
│ ┌────────┐                     ┌────────┐                  ┌───────────┐ │
│ │  User  │                     │  Mint  │                  │   OpenID  │ │
├─┴────────┘─────────────────────└────────┴──────────────────└───────────┴─┤
│                                                                          │
│                           1. Clear authentication                        │
│                           =======================                        │
│                                                                          │
│                                       Mint registers OpenID service      │
│                                     ◄───────────────────────────────     │
│                                                                          │
│           Wallet GET /v1/info                                            │
│    ─────────────────────────────────►                                    │
│                                                                          │
│                                OpenID login                              │
│    ────────────────────────────────────────────────────────────────►     │
│                                                                          │
│                              Respond with CAT                            │
│    ◄────────────────────────────────────────────────────────────────     │
│                                                                          │
│                           2. Blind authentication                        │
│                           =======================                        │
│                                                                          │
│           Request BAT using CAT                                          │
│    ─────────────────────────────────►                                    │
│                                                                          │
│                Return BAT                                                │
│    ◄─────────────────────────────────                                    │
│                                                                          │
│           Use BAT to access mint                                         │
│    ─────────────────────────────────►                                    │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘

```

`1. 명시적 인증` 단계는 [NUT-21][21]에 설명되어 있고, `2. 블라인드 인증` 단계는 본 문서에서 다룬다.

## 엔드포인트

민트는 기존 eCash 키 조회, 키셋 조회, 토큰 발행 엔드포인트([NUT-01][01], [NUT-02][02], [NUT-04][04])와 유사한 새로운 엔드포인트를 제공한다. 이 엔드포인트는 `/v1/auth/` 접두사를 갖고, 이를 통해 월렛은 BAT를 발행받고 나중에 보호된 엔드포인트 접근에 사용한다. BAT는 BAT로 스왑할 수 없다.

### Keys

[NUT-01][01], [NUT-02][02]와 동일하게 민트는 BAT 키셋을 반환한다:

```
GET /v1/auth/blind/keys
```

또는

```
GET /v1/auth/blind/keys/{keyset_id}
```

응답 (`GetKeysResponse`):

```json
{
  "keysets": [
    {
      "id": "000e479673849bf6",
      "unit": "auth",
      "keys": {
        "1": "024ec000e31e230e4c59760def29601557c0b1650617dc8f38d3b2cfd21ad0351b"
      }
    }
  ]
}
```

단위는 `auth`이며 금액 `1`만 지원한다.

### Keysets

[NUT-02][02]와 동일하게 키셋 반환:

```
GET v1/auth/blind/keysets
```

## BAT 발행

BAT 발급 요청:

```http
POST /v1/auth/blind/mint
```

엔드포인트가 보호된 경우, 요청 헤더에 유효한 CAT 필요:

```
Clear-auth: <CAT>
```

요청 바디 (`PostAuthBlindMintRequest`):

```json
{
  "outputs": <Array[BlindedMessage]>
}
```

출력 총합은 `MintBlindAuthSetting`의 `bat_max_mint`를 초과할 수 없다.

[NUT-04][04]와 달리 quote를 만들지 않고 바로 최대 BAT를 발행한다.

응답 (`PostAuthBlindMintResponse`):

```json
{
  "signatures": <Array[BlindSignature]>
}
```

월렛은 언블라인드 후 다음 형태로 저장:

```json
{
  "id": <hex_str>,
  "secret": <str>,
  "C": <hex_str>,
  "dleq": {
    "e": <str>,
    "s": <str>,
    "r": <str>
  }
}
```

핀닝 방지를 위해 DLEQ 검증 필수([NUT-12]). 타 사용자에게 전송 시 DLEQ 포함 필요.

## BAT 사용

월렛은 `MintBlindAuthSetting`을 확인하여 보호된 엔드포인트 여부를 판단한다. 보호된 경우 BAT를 요청 헤더에 추가한다.

### 직렬화

BAT 형식:

```sh
authA[base64_authproof_json]
```

> 주의  
> 민트로 보낼 때 BAT에는 `dleq`가 포함되면 안 된다.

### 요청 헤더

```
Blind-auth: <BAT>
```

BAT는 1회용. 성공 후 삭제 필수. 오류 시 삭제 권장. 부족하면 CAT으로 재발행 가능.

## 민트

### DLEQ

민트는 모든 블라인드 서명에 대해 DLEQ를 반환해야 한다.

### 보호 엔드포인트 표시

[NUT-06][06] info 응답 예:

```json
"22" : {
  "bat_max_mint": 50,
  "protected_endpoints": [
    {
      "method": "GET",
      "path": "^/v1/mint/.*"
    },
    {
      "method": "POST",
      "path": "^/v1/mint/.*"
    }
  ]
}
```

## 오류 코드

- `31001`: BAT 필요
- `31002`: BAT 인증 실패
- `31003`: BAT 발행 한도 초과
- `31004`: BAT 발행 속도 제한 초과

[00]: 00.md
[01]: 01.md
[02]: 02.md
[03]: 03.md
[04]: 04.md
[05]: 05.md
[06]: 06.md
[21]: 21.md
[errors]: error_codes.md
