# NUT-21: 명시적 인증 (Clear Authentication)

`optional`

`used in: NUT-22`

---

이 NUT는 OAuth 2.0 및 OpenID Connect 프로토콜을 사용하여 등록된 사용자만 민트를 사용할 수 있도록 제한하는 명시적 인증 방식을 정의한다. 민트 운영자는 특정 엔드포인트에 대해 사용자 인증을 요구하여 접근을 보호할 수 있다. 지정된 OpenID Connect(OIDC) 서비스에서 제공된 명시적 인증 토큰(CAT, clear authentication token)을 제출한 사용자만 보호된 엔드포인트를 사용할 수 있다.  
CAT은 `access_token`이라고도 불리는 OAuth 2.0 액세스 토큰이며, 일반적으로 JWT 형식으로 사용자 정보, OIDC 서비스의 서명, 만료 시간이 포함된다. 보호된 엔드포인트에 접근하기 위해 월렛은 HTTP 요청 헤더에 CAT을 포함한다.

**Note:** 이 NUT의 주요 목적은 [NUT-22][22]에서 설명된 블라인드 인증 토큰(BAT)을 등록된 사용자가 얻을 수 있도록 민트 접근을 제한하는 것이다.

**Warning:** CAT에는 사용자 정보가 포함되므로 이 인증 방식은 사용자의 프라이버시를 침해한다. 민트 운영자는 **BAT 발급 엔드포인트와 같은 특정 엔드포인트에만** 명시적 인증을 요구해야 한다.

## OpenID Connect 서비스 설정

OpenID Connect(OIDC) 서비스는 일반적으로 민트 운영자가 실행하지만 반드시 그래야 하는 것은 아니다. OIDC 서비스는 다음 요구 사항을 충족해야 한다:

- **클라이언트 시크릿 없음:** OIDC 서비스는 클라이언트 시크릿을 사용해서는 안 된다.
- **Authorization Code Flow:** OIDC 서비스는 공개 클라이언트를 위한 PKCE가 포함된 인증 코드 흐름을 지원해야 하며, 이를 통해 인증 코드를 액세스 토큰 및 리프레시 토큰으로 교환할 수 있어야 한다.
- **서명 알고리즘:** OIDC 서비스는 액세스 토큰 및 ID 토큰 서명에 대해 `ES256` 또는 `RS256` 중 하나 이상의 비대칭 JWS 서명 알고리즘을 지원해야 한다.
- **월렛 리디렉션 URL:** OIDC 서비스는 지원하려는 Cashu 월렛들의 리디렉션 URL을 허용해야 한다. 일반적인 Cashu 월렛 리디렉션 URL 목록은 [여기][21-SUPPL]에서 확인 가능하다.
- **localhost 리디렉션 URL 허용:** `http://localhost:33388/callback` 리디렉션을 허용해야 한다.
- **인증 플로우:** 적어도 `authorization_code`(Authorization Code) 흐름과 `urn:ietf:params:oauth:grant-type:device_code`(Device Code) 흐름을 허용하는 것을 권장한다. ROPC(Resource Owner Password Credentials) 방식은 사용자 자격 정보를 월렛 애플리케이션이 직접 처리해야 하므로 사용해서는 안 된다.

## Mint

### 보호된 엔드포인트 신호화

민트는 [NUT-06][06] info 응답에서 `MintClearAuthSetting` 내에 CAT이 필요한 보호 엔드포인트 목록을 제공한다:

```json
"21" : {
  "openid_discovery": "https://mint.com:8080/realms/nutshell/.well-known/openid-configuration",
  "client_id": "cashu-client",
  "protected_endpoints": [
    {
        "method": "POST",
        "path": "/v1/auth/blind/mint"
    }
  ]
}
```

- `openid_discovery`: OIDC 디스커버리 엔드포인트(URL), 클라이언트가 필요한 인증 정보를 얻는다
- `client_id`: 월렛이 인증 시 사용해야 하는 OpenID Connect Client ID
- `protected_endpoints`: CAT이 필요한 엔드포인트 목록 (`method` + `path`)

`path`는 문자열(정확 일치) 또는 정규식일 수 있다.  
예시에서 보호된 엔드포인트는 [NUT-22][22]의 BAT 발급 엔드포인트이다.

### CAT 검증

보호된 엔드포인트 요청 시, 민트는 요청 헤더에 포함된 CAT(JWT)을 검증한다:

- JWT 서명이 유효한지 확인
- 만료 시간 확인

JWT는 특정 사용자를 식별하는 `sub` 필드를 포함한다. `sub`는 예를 들어 사용자별 rate limit에 사용될 수 있다.

> 참고: JWT에 `aud` 필드가 포함되어 있을 수 있으며, 이는 민트의 공개키를 포함할 수 있다.

ID 토큰 검증에 관한 자세한 내용:  
https://openid.net/specs/openid-connect-core-1_0.html#IDTokenValidation

## Wallet

월렛은 민트의 info 엔드포인트에서 제공되는 `MintClearAuthSetting` 안의 `openid_discovery` URL을 사용해 OIDC 서비스와 인증하고 CAT을 얻는다.

### CAT 획득

월렛은 상황에 따라 적절한 인증 플로우를 사용해야 한다:

- 모바일 월렛 → Authorization Code flow 권장
- CLI 월렛 → Device Code flow 권장
- 헤드리스 환경 → 필요 시 ROPC 가능(비권장)

월렛은 액세스 토큰과 리프레시 토큰을 저장할 수 있어야 한다. 리프레시 토큰 만료 시 사용자에게 재로그인을 요청할 수 있어야 한다.

이 문서에서 말하는 CAT은 `access_token`을 의미한다.

### 요청 헤더 내 CAT 포함

월렛은 요청하려는 엔드포인트가 `protected_endpoints`에 해당하는지 확인한다.  
해당되면 요청 헤더에 CAT을 추가해야 한다:

```
Clear-auth: <CAT>
```

CAT은 base64로 인코딩된 JWT이며, OIDC 서비스가 서명한다. 민트는 JWT를 검증한다.

## 오류 코드

- `30001`: 엔드포인트가 명시적 인증 필요
- `30002`: 명시적 인증 실패

[06]: 06.md  
[21-SUPPL]: suppl/21.md  
[22]: 22.md  
[errors]: error_codes.md
