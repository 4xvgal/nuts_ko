# NUT-04: 토큰 발행 (Mint tokens)

`mandatory`

`used in: NUT-20, NUT-23`

---

토큰 발행은 두 단계로 이루어진다: **민트 견적 요청(mint quote request)** 과 **새로운 토큰 발행(minting new tokens)**.  
이 문서는 모든 결제 방식에 공통적으로 적용되는 일반적인 흐름을 설명하며, 각 결제 방식별 세부 내용은 별도의 NUT 문서에 정의되어 있다.



## 지원되는 방식 (Supported methods)

결제 방식별 NUT 문서는 각 방식의 처리 절차를 정의한다. 현재 명세된 모델은 다음과 같다.

- [NUT-23][23]: BOLT11 라이트닝 인보이스
- [NUT-25][25]: BOLT12 라이트닝 오퍼



## 일반적인 흐름 (General Flow)

모든 결제 방식에서 민팅 절차는 다음 단계를 따른다.

1. 지갑은 발행할 `unit`과 결제 `method`를 지정하여 민트 견적(quote)을 요청한다.  
2. 민트는 `quote` ID와 결제 `request`를 포함한 견적을 반환한다.  
3. 사용자는 지정된 결제 방식으로 해당 `request`를 결제한다.  
4. 지갑은 `quote` ID와 새로운 `outputs`를 포함하여 민트에 새 토큰 발행을 요청한다.  
5. 민트는 결제를 확인하고 블라인드 서명(Blind Signatures)을 반환한다.



## 공통 요청 및 응답 형식

### 민트 견적 요청 (Requesting a Mint Quote)

지갑(`Alice`)은 다음과 같이 `POST /v1/mint/quote/{method}` 요청을 보낸다.  
여기서 `{method}`는 결제 방식(`bolt11`, `bolt12` 등)을 의미한다.

```http
POST https://mint.host:3338/v1/mint/quote/{method}
```

결제 방식에 따라 요청 구조는 다를 수 있으나, 모든 방식에는 최소한 다음 필드가 포함된다.

```json
{
  "unit": <str_enum[UNIT]>
  // 방식별 추가 필드가 필요할 수 있음
}
```

민트(`Bob`)는 다음과 같은 공통 구조로 응답한다.

```json
{
  "quote": <str>,
  "request": <str>,
  "unit":  <str_enum[UNIT]>
  // 방식별 추가 필드 포함 가능
}
```

- `quote`: 견적 ID  
- `request`: 결제 요청 문자열  
- `unit`: 요청 시 지정한 단위

> [!CAUTION]
>
> `quote`는 민트가 내부적으로 결제 상태를 조회하기 위해 생성한 **고유하고 무작위한 ID**이다.  
> `quote`는 사용자와 민트 사이의 **비밀**로 유지되어야 하며, 결제 요청(`request`)으로부터 유도 가능해서는 안 된다.  
> 제3자가 `quote`를 알게 되면 발행될 토큰을 가로챌 수 있다.  
> 이를 방지하려면 [NUT-20][20]의 **락(lock) 메커니즘**을 사용해 공개키 인증을 강제해야 한다.



### 민트 견적 상태 확인 (Check Mint Quote State)

지갑은 결제가 완료되었는지 확인하기 위해 다음 요청을 보낼 수 있다.

```http
GET https://mint.host:3338/v1/mint/quote/{method}/{quote_id}
```

민트는 초기 견적 응답과 동일한 구조로 응답한다.



### 민트 실행 (Executing a Mint Quote)

결제 요청을 수행한 후, 지갑은 `POST /v1/mint/{method}` 엔드포인트를 호출하여 새로운 토큰 발행을 요청한다.

```http
POST https://mint.host:3338/v1/mint/{method}
```

요청 본문에는 다음 공통 데이터가 포함된다.

```json
{
  "quote": <str>,
  "outputs": <Array[BlindedMessage]>
}
```

- `quote`: 앞서 받은 견적 ID  
- `outputs`: 서명을 요청하는 `BlindedMessages` 배열 ([NUT-00][00] 참조)  
  각 `outputs`의 총합은 견적에서 요청된 금액(`amount`)과 동일해야 한다.

민트는 다음과 같이 응답한다.

```json
{
  "signatures": <Array[BlindSignature]>
}
```

여기서 `signatures`는 요청된 출력들에 대한 블라인드 서명 배열이다.



## 새로운 결제 방식 추가 (Adding New Payment Methods)

새로운 결제 방식을 추가하려면 다음을 구현해야 한다.

1. 위의 패턴을 따라 방식별 요청/응답 구조 정의  
2. 세 가지 필수 엔드포인트 구현:  
   - `quote` 요청  
   - `quote` 상태 확인  
   - `mint` 실행  
3. 설정(settings)에 새로운 방식 등록



## 설정 (Settings)

이 NUT의 설정은 민트가 지원하는 방식(method)과 단위(unit) 쌍을 나타낸다.  
이는 민트의 정보 응답([NUT-06][06])에 포함된다.

```json
{
  "4": {
    "methods": [
      <MintMethodSetting>,
      ...
    ],
    "disabled": <bool>
  }
}
```

`MintMethodSetting`은 지원되는 `method`와 `unit` 쌍 및 추가 설정을 포함하며,  
`disabled`는 민팅 기능이 비활성화되었는지를 나타낸다.

형식은 다음과 같다.

```json
{
  "method": <str>,
  "unit": <str>,
  "min_amount": <int|null>,
  "max_amount": <int|null>,
  "options": <Object|null>
}
```

- `min_amount` / `max_amount`: 해당 방식-단위 조합의 최소/최대 금액  
- `options`: 방식별로 정의되는 추가 옵션 (해당 방식의 NUT에서 정의)



## 서명 언블라인딩 (Unblinding Signatures)

민트로부터 `BlindSignatures`를 받은 후, 지갑은 이를 언블라인드하여 `Proofs`를 생성한다.  
이는 블라인딩 인자 `r`와 민트의 공개키 `K`를 사용하여 수행된다. (참조: BDHKE [NUT-00][00])  
지갑은 이렇게 생성된 `Proofs`를 데이터베이스에 저장한다.



[00]: 00.md  
[01]: 01.md  
[02]: 02.md  
[03]: 03.md  
[04]: 04.md  
[05]: 05.md  
[06]: 06.md  
[07]: 07.md  
[08]: 08.md  
[09]: 09.md  
[10]: 10.md  
[11]: 11.md  
[12]: 12.md  
[20]: 20.md  
[23]: 23.md  
[25]: 25.md  
